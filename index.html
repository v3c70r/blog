<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"qgu.io","root":"/blog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Ideas are mine and mine only">
<meta property="og:type" content="website">
<meta property="og:title" content="QGU">
<meta property="og:url" content="https://qgu.io/blog/index.html">
<meta property="og:site_name" content="QGU">
<meta property="og:description" content="Ideas are mine and mine only">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Q Gu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://qgu.io/blog/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>QGU</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">QGU</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Quantum Gravity Unitarity</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qgu.io/blog/2022/05/22/vulkan-imgui-image/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Q Gu">
      <meta itemprop="description" content="Ideas are mine and mine only">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QGU">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2022/05/22/vulkan-imgui-image/" class="post-title-link" itemprop="url">Integrating ImGui Image Display Widget in Muyo Vulkan Renderer</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-22 06:00:00" itemprop="dateCreated datePublished" datetime="2022-05-22T06:00:00+00:00">2022-05-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-25 19:54:14" itemprop="dateModified" datetime="2022-05-25T19:54:14+00:00">2022-05-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/vulkan/" itemprop="url" rel="index"><span itemprop="name">vulkan</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure>
<img src="https://i.imgur.com/m7mhHiP.png" alt="result" /><figcaption>result</figcaption>
</figure>
<p><code>ImGui</code> comes with a handy image widget in their demo page. It works magically in my engine to display the built-in font textures, even though I didn't explicitly bind it during the runtime. The <code>ImGui::Image()</code> function to draw pictures has a <code>textureId</code>, which is also unclear to me.</p>
<p>Since I'm writing my own rendering backend, I took some time to investigate how the <code>textureId</code> works. When we call <code>ImGui::Image(textureId, ...)</code>, ImGui creates a draw command to draw a rectangle, and set the <code>ImDrawCmd::TextureId</code> variable with the <code>textureId</code> we pass in. During the execution time, <code>ImDrawCmd::TextureId</code> is accessible when we prepare the GPU command buffer. That said, <code>TextureId</code> serves simply as an index of the texture we want to bind. We have to implement the array of <em>texture information structure</em> that can be bond to pipeline when we record the command buffer.</p>
<h2 id="a-fast-solution">A Fast Solution</h2>
<p>In the <a target="_blank" rel="noopener" href="https://github.com/ocornut/imgui/issues/1641">issue</a> the author of ImGui has discussed to wrap the texture into a <code>VkDescriptorSet</code> handle, and pass it as <code>textureId</code>. It works as the fact that <code>typedef void* ImTextureID</code> has 64 bits on a 64-bit machine, while <code>VkDescriptorSet</code> has also 64 bits. However, this doesn't hold on a 32-bit machines. That's reason why the Vulkan ImGui demo implementation has no implementation of <code>ImGui::Image()</code> yet.</p>
<h2 id="not-that-fast-solution">Not That Fast Solution</h2>
<p>The fast solution inspired me that I can track descriptor sets with <code>textureId</code>. In my solution, I use my <a target="_blank" rel="noopener" href="https://github.com/v3c70r/Muyo/blob/0ad38fbcdc68ea47930ae9f7a0dd602ea01a3ddf/src/DescriptorManager.h#L203">DescriptorManager</a> to create and track a list of descriptor sets used in ImGui, where the list is addressed by <code>textureId</code>. I also keep a map from resource identifier to <code>textureId</code> so that I can use bind the resource when I draw image with <code>ImGui::Image()</code>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;VkDescriptorSet&gt; m_vImGuiTextureDescriptorSets;</span><br><span class="line">std::map&lt;std::string, <span class="type">size_t</span>&gt; m_mImGuiTextureIds;</span><br></pre></td></tr></table></figure>
<p>Note that the first <code>textureId</code> is reserved for font textures. <code>ImDrawCmd::TextureId</code> is zero when there's no <code>ImGui::Image()</code> called on the draw command. To honour this, I have to insert the font texture as the first ImGui texture when creating resources for ImGui.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create font texture</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* fontData;</span><br><span class="line"><span class="type">int</span> texWidth, texHeight;</span><br><span class="line">io.Fonts-&gt;<span class="built_in">GetTexDataAsRGBA32</span>(&amp;fontData, &amp;texWidth, &amp;texHeight);</span><br><span class="line"></span><br><span class="line"><span class="comment">// UI font texture has texture id of 0. It has to be inserted before other texture</span></span><br><span class="line"><span class="built_in">GetRenderResourceManager</span>()-&gt;<span class="built_in">GetTexture</span>(<span class="string">&quot;ui_font_texture&quot;</span>, fontData, texWidth, texHeight);</span><br><span class="line"><span class="built_in">GetDescriptorManager</span>()-&gt;<span class="built_in">GetImGuiTextureId</span>(<span class="string">&quot;ui_font_texture&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>The other textures can be inserted with the same fashion. For example, I can display my environment map with ImGui like this.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">ImTextureID my_tex_id = (<span class="type">void</span>*)<span class="built_in">GetDescriptorManager</span>()-&gt;<span class="built_in">GetImGuiTextureId</span>(<span class="string">&quot;EnvMap&quot;</span>);</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">ImGui::<span class="built_in">Image</span>(my_tex_id, <span class="built_in">ImVec2</span>(my_tex_w, my_tex_h), uv_min, uv_max, tint_col, border_col);</span><br></pre></td></tr></table></figure>
<p>During the draw call, we can simply bind the corresponding descriptor set based on the <code>TextureId</code> in draw command like <a target="_blank" rel="noopener" href="https://github.com/v3c70r/Muyo/blob/0ad38fbcdc68ea47930ae9f7a0dd602ea01a3ddf/src/RenderPassUI.cpp#L265">this</a>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">vkCmdBindDescriptorSets</span>(curCmdBuf, VK_PIPELINE_BIND_POINT_GRAPHICS, m_pipelineLayout, <span class="number">0</span>, <span class="number">1</span>, &amp;<span class="built_in">GetDescriptorManager</span>()-&gt;<span class="built_in">GetImGuiTextureDescriptorSet</span>((<span class="type">size_t</span>)drawCmd.TextureId), <span class="number">0</span>, <span class="literal">nullptr</span>);</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qgu.io/blog/2020/10/30/oblique-clipping-plane/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Q Gu">
      <meta itemprop="description" content="Ideas are mine and mine only">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QGU">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020/10/30/oblique-clipping-plane/" class="post-title-link" itemprop="url">Oblique Plane in Clip Space with Z in [0, 1.0] and reversed Z</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-10-30 02:00:00" itemprop="dateCreated datePublished" datetime="2020-10-30T02:00:00+00:00">2020-10-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-25 19:54:14" itemprop="dateModified" datetime="2022-05-25T19:54:14+00:00">2022-05-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Oblique clipping plane in frustum can be used to cull primitives with arbitrary plane. It's especially useful in rasterizing mirrors. <a target="_blank" rel="noopener" href="http://www.terathon.com/lengyel/Lengyel-Oblique.pdf">The paper by Eric Lengyel</a> has discussed the derivation of such clipping plane in OpenGL NDC with <span class="math inline">\(x, y, z \in [-1.0, 1.0]\)</span>. However in other APIs like D3D and Vulkan, the z lies in <span class="math inline">\(z\in[0.0, 1.0]\)</span> . This article discusses how we modify the original method proposed in the paper to achieve the same result.</p>
<p>In addition, we'll talk about how to handle the matrix with reversed Z techniques.</p>
<p>In the following discussion, elements with <em>prime(')</em> are in view space, otherwise, they are in clip space. There are the notations we used in the following discussion:</p>
<ul>
<li><span class="math inline">\(C_n\)</span>: Near clipping plane in clip space, <span class="math inline">\(C_n&#39;\)</span> is the clipping plane in view space.</li>
<li><span class="math inline">\(C_f\)</span>: Far clipping plane in clip space, <span class="math inline">\(C_f&#39;\)</span> is the far clipping plane in view space.</li>
<li><span class="math inline">\(M\)</span>: Projection matrix where <span class="math inline">\(M_n\)</span> denotes the <em>n</em>th row , i.e.:</li>
</ul>
<p><span class="math display">\[M = \begin{pmatrix}
M_1\\ 
M_2\\ 
M_3\\ 
M_4
\end{pmatrix}\]</span> * <span class="math inline">\(Q\)</span> denotes a point opposite to the near clipping plane. We'll discuss it later.</p>
<h2 id="oblique-clipping-plane">Oblique Clipping Plane</h2>
<blockquote>
<p>TL;DR</p>
<p>Substitute the third row of projection <span class="math inline">\(M_3\)</span> with <span class="math display">\[M_3=\frac{M_4\cdot Q&#39;}{C_n \cdot Q&#39;}C_n&#39;\]</span> where <span class="math inline">\(Q&#39; = M^{-1}Q\)</span> and <span class="math inline">\(Q=(sgn({C_n}_x), sgn({C_n}_y), 1, 1))\)</span></p>
</blockquote>
<p>Giving a normal <span class="math inline">\(\mathbf{n}\)</span> and a point <span class="math inline">\(\mathbf{p}\)</span>, we can construct a plane <span class="math inline">\(C=&lt;\mathbf{n}_x, \mathbf{n}_y, \mathbf{n}_z, -\mathbf{n}\cdot \mathbf{p}\)</span>&gt;. Also, to transform a plane from view space to clip space, we need to apply the transpose of inverse of the matrix. <span class="math display">\[C = (M^{-1})^TC&#39;\]</span> This gives us the transformation of a plane from clip space to view space: <span class="math display">\[C&#39; = M^TC\]</span> Picking a point <span class="math inline">\(\mathbf{p_n}=(0, 0, 0)\)</span> and normal <span class="math inline">\(\mathbf{n_n}=(0, 0, 1)\)</span>on the near plane in clip space, we can have near clipping plane: <span class="math display">\[C_n=&lt;0, 0, 1, 0&gt;\]</span> The transformation of the plane from clip space to view space: <span class="math display">\[C_n&#39; = M^TC_n=(M_1, M_2, M_3, M4)(0, 0, 1, 0)=M_3\]</span></p>
<p>Similarly, picking a point <span class="math inline">\(\mathbf{p_f}=(0, 0, 1)\)</span> and normal <span class="math inline">\(\mathbf{n_f}=(0, 0, -1)\)</span> on the far clipping plane, we have: <span class="math display">\[C_f=&lt;0, 0, -1, 1&gt;\]</span> <span class="math display">\[C_f&#39; = M^TC_f=M_4-M_3=M_4-C_n&#39;\]</span> As discussed in the original paper, we want to find a scale factor <span class="math inline">\(a\)</span> that makes far plane <span class="math inline">\(C&#39;_f = M_4 - aC&#39;_n\)</span> crosses its opposite point <span class="math inline">\(Q\)</span> in the original clipp space, see the Q illustrated in the image. <img src="https://i.imgur.com/1hwILu2.png" alt="Q position" /> Then we can have the following equations:</p>
<p><span class="math display">\[
\left\{\begin{array}{ll}
Q&#39;\cdot C_f&#39;=0
\\
C&#39;_f=M_4-C_n&#39;
\\
Q&#39;=M^{-1}Q
\\ 
Q=(sgn({C_n}_x), sgn({C_n}_y), 1, 1))
\end{array}\right.
\]</span></p>
<p><span class="math display">\[
\Rightarrow 
\left\{\begin{array}{ll}
a=\frac{M_4\cdot Q&#39;}{C_n&#39;\cdot Q&#39;}C_n&#39;
\\
Q&#39;=M^{-1}Q
\\ 
Q=(sgn({C_n}_x), sgn({C_n}_y), 1, 1))
\\
M_3 = aC_n&#39;
\end{array}\right.
\]</span></p>
<h2 id="a-note-on-reversed-near-far-planes">A Note on Reversed Near Far Planes</h2>
<p>It's not uncommon to use the <a target="_blank" rel="noopener" href="http://www.humus.name/index.php?page=Comments&amp;ID=255&amp;start=0">reversed Z trick</a> to gain more precision from the depth buffer to facilitate linear depth reconstruction. This trick simply swapped near and far planes in the projection matrix and use <em>GREATER</em> for depth test function. However, this trick introduces complexity in the equations above. One easy way to handle this is to apply a Z flipping matrix <span class="math inline">\(M_f\)</span> after applying the oblique clipping plane, where:</p>
<p><span class="math display">\[M_f = \begin{bmatrix}
1 &amp;  0&amp;  0&amp; 0\\ 
0 &amp;  1&amp;  0&amp; 0\\ 
0 &amp;  0&amp;  -1&amp; 1\\ 
0 &amp;  0&amp;  1&amp; 1
\end{bmatrix}\]</span></p>
<h2 id="further-discussions-on-view-space-z-reconstruction">Further discussions on view space z reconstruction</h2>
<p>In the traditional projection matrix, depth can be reconstructed by simply knowing the depth at that pixel position, this is because the first two elements in the 3rd row(<span class="math inline">\(M_3\)</span>) are 0. When <span class="math inline">\(w&#39;=1\)</span>, depth remapping can be simply written as a function of clip space depth <span class="math inline">\(z\)</span>: <span class="math display">\[z = \frac{M_{33}z&#39;+M_{34}}{-z&#39;}\rightarrow z&#39;=\frac{M_{34}}{M_{33}+z}\]</span></p>
<p>However, when <span class="math inline">\(M_{31}\)</span> and <span class="math inline">\(M_{32}\)</span> are no longer 0, we'll need the clip space positions to reconstruct the depth. Given a point <span class="math inline">\(\mathbf{p}(x, y, z, 1)\)</span> in clip space, we can reconstruct the depth in view space <span class="math inline">\(z&#39;\)</span>:</p>
<p><span class="math display">\[
\left\{\begin{array}{ll}
x&#39;=\frac{x}{M_{11}}
\\
y&#39; = \frac{y}{M_{22}}
\\ 
z=\frac{\mathbf{M_3}\cdot \mathbf{p&#39;}}{-z&#39;}
\end{array}\right.
\Rightarrow z&#39;=-\frac{\frac{M_{31}}{M_{11}}x+\frac{M_{32}}{M_{22}}y+M_{34}}{M_{33}+z}
\]</span></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qgu.io/blog/2020/08/13/vulkan-multiview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Q Gu">
      <meta itemprop="description" content="Ideas are mine and mine only">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QGU">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020/08/13/vulkan-multiview/" class="post-title-link" itemprop="url">Render to CubeMap with Vulkan Multiview</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-13 06:00:00" itemprop="dateCreated datePublished" datetime="2020-08-13T06:00:00+00:00">2020-08-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-25 19:54:14" itemprop="dateModified" datetime="2022-05-25T19:54:14+00:00">2022-05-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/vulkan/" itemprop="url" rel="index"><span itemprop="name">vulkan</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="render-to-cubemap-with-vulkan-multiview">Render to CubeMap with Vulkan Multiview</h2>
<p>Vulkan has introduced <a target="_blank" rel="noopener" href="https://github.com/KhronosGroup/Vulkan-Docs/blob/master/appendices/VK_KHR_multiview.txt"><code>VK_KHR_multiview</code></a> in Vulkan 1.1 to facilitate the implementation of VR rendering. It allows user to index data with <code>gl_ViewIndex</code> and output it to the corresponding layer of the attachment image view.</p>
<p>In my use case, I have encountered a situation while implementing PBR pipeline where I need to render HDR map and radiance map to cube maps. Each face of the cube map is generated with a camera placed orthogonally to each other.</p>
<h2 id="enable-extensions">Enable Extensions</h2>
<p>There are extensions we need to enable on the logical device and on the instance.</p>
<p>Logical: <code>VK_KHR_MULTIVIEW_EXTENSION_NAME</code>,</p>
<p>Instance: <code>VK_KHR_get_physical_device_properties2</code></p>
<h2 id="fill-multiview-create-info-struct">Fill Multiview Create Info Struct</h2>
<p>Multiview usage is declared while creating render pass. To tell the render pass to use mutliview, simply fill a multiview create info <code>VkRenderPassMultiviewCreateInfo</code>, and put it to the <code>pNext</code> of the renderpass create info</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">VkRenderPassMultiviewCreateInfo multiViewCI = &#123;&#125;;</span><br><span class="line">multiViewCI.sType = VK_STRUCTURE_TYPE_RENDER_PASS_MULTIVIEW_CREATE_INFO;</span><br><span class="line">multiViewCI.subpassCount = viewMasks.<span class="built_in">size</span>();</span><br><span class="line">multiViewCI.pViewMasks = viewMasks.<span class="built_in">data</span>();</span><br><span class="line"></span><br><span class="line">VkRenderPassCreateInfo renderPassInfo = &#123;&#125;;</span><br><span class="line">renderPassInfo.pNext = &amp;multiViewCI;</span><br><span class="line"><span class="comment">//... Other Renderpass Info...</span></span><br></pre></td></tr></table></figure>
<h2 id="create-image-and-framebuffer-to-take-the-output">Create Image and Framebuffer to Take the output</h2>
<p>Each view will write to the corresponding layer of the attachment of the framebuffer. So the Image of the attachment needs to be number of view layers. However, the framebuffer can have only 1 layer. It’s the attachment to have multiple layers. Here’s an explanation form the specification: <a target="_blank" rel="noopener" href="https://www.khronos.org/registry/vulkan/specs/1.2-extensions/man/html/VkFramebufferCreateInfo.html">VkFramebufferCreateInfo</a>. <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This is my code to generate a image and view</span></span><br><span class="line"><span class="comment">// with 1 mip and 6 layers</span></span><br><span class="line">VkImageView view = <span class="built_in">GetRenderResourceManager</span>()</span><br><span class="line">    -&gt;<span class="built_in">getColorTarget</span>(<span class="string">&quot;irr_cube_map&quot;</span>, &#123;IRR_CUBE_DIM, IRR_CUBE_DIM&#125;,</span><br><span class="line">                     TEX_FORMAT, <span class="number">1</span>, <span class="number">6</span>) <span class="comment">// &lt;- 1 mip, 6 layers</span></span><br><span class="line">                     -&gt;<span class="built_in">getView</span>();</span><br><span class="line"><span class="comment">// Create framebuffer</span></span><br><span class="line">VkFramebufferCreateInfo frameBufferCreateInfo = &#123;&#125;;</span><br><span class="line">frameBufferCreateInfo.sType = VK_STRUCTURE_TYPE_FRAMEBUFFER_CREATE_INFO;</span><br><span class="line">frameBufferCreateInfo.layers = <span class="number">1</span>; <span class="comment">// &lt;- 1 layer for framebuffer</span></span><br><span class="line">frameBufferCreateInfo.pAttachments = &amp;view;</span><br><span class="line"><span class="comment">// ... other framebuffer info</span></span><br></pre></td></tr></table></figure></p>
<h2 id="enable-shader-extension-and-use-the-view-index">Enable Shader Extension and Use the View Index</h2>
<p>The only change I made is in the vertex shader to index ProjectView matrix with <code>gl_ViewIndex</code>. <figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#extension GL_EXT_multiview : enable // &lt;- Enable shader extension</span></span><br><span class="line"><span class="comment">// Hardcoded mPV for each face of the cube</span></span><br><span class="line"><span class="type">mat4</span> mProjViews[<span class="number">6</span>] = &#123;&#123;&#123;<span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">1.010101</span>, <span class="number">1.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">0.000000</span>, <span class="number">-1.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">-1.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">-0.101010</span>, <span class="number">0.000000</span>&#125;&#125;,</span><br><span class="line">                      &#123;&#123;<span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">-1.010101</span>, <span class="number">-1.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">0.000000</span>, <span class="number">-1.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">1.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">-0.101010</span>, <span class="number">0.000000</span>&#125;&#125;,</span><br><span class="line">                      &#123;&#123;<span class="number">1.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">1.010101</span>, <span class="number">1.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">0.000000</span>, <span class="number">1.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">-0.101010</span>, <span class="number">0.000000</span>&#125;&#125;,</span><br><span class="line">                      &#123;&#123;<span class="number">1.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">-1.010101</span>, <span class="number">-1.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">0.000000</span>, <span class="number">-1.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">-0.101010</span>, <span class="number">0.000000</span>&#125;&#125;,</span><br><span class="line">                      &#123;&#123;<span class="number">1.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">0.000000</span>, <span class="number">-1.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">1.010101</span>, <span class="number">1.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">-0.101010</span>, <span class="number">0.000000</span>&#125;&#125;,</span><br><span class="line">                      &#123;&#123;<span class="number">-1.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">0.000000</span>, <span class="number">-1.000000</span>, <span class="number">0.000000</span>, <span class="number">0.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">-1.010101</span>, <span class="number">-1.000000</span>&#125;,</span><br><span class="line">                       &#123;<span class="number">0.000000</span>, <span class="number">0.000000</span>, <span class="number">-0.101010</span>, <span class="number">0.000000</span>&#125;&#125;&#125;;</span><br><span class="line"><span class="comment">// Indexing the output</span></span><br><span class="line"><span class="built_in">gl_Position</span> = mProjViews[gl_ViewIndex] * <span class="type">vec4</span>(inPos, <span class="number">1.0</span>);</span><br></pre></td></tr></table></figure> Don't forget to enable shader extension: <code>#extension GL_EXT_multiview : enable</code>.</p>
<h2 id="implementations-note">Implementations note</h2>
<ul>
<li>Mutliview is not supported by MacOS with MoltenVK, track the feature <a target="_blank" rel="noopener" href="https://github.com/KhronosGroup/MoltenVK/issues/347">at Github issue</a>.</li>
<li>Skybox need to change front face mode since we are looking from the inside. This applies if you are using a cube mesh like I do.</li>
<li>glm need to force the range between 0, 1 using macro: <code>#defineGLM_FORCE_DEPTH_ZERO_TO_ONE</code></li>
</ul>
<h2 id="bonus-code-to-generate-cube-views">Bonus: Code to generate cube views</h2>
<p>Here's the code I used to generate the hard coded View matrices used in the shader above to look at 6 faces of the cube. <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> GLM_ENABLE_EXPERIMENTAL</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GLM_FORCE_DEPTH_ZERO_TO_ONE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;glm/glm.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;glm/glm/gtc/matrix_transform.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;glm/glm/gtx/string_cast.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    glm::mat4 captureProjection =</span><br><span class="line">        glm::<span class="built_in">perspective</span>((<span class="type">float</span>)M_PI / <span class="number">2.0f</span>, <span class="number">1.0f</span>, <span class="number">0.1f</span>, <span class="number">10.0f</span>);</span><br><span class="line">    glm::mat4 captureViews[] = &#123;</span><br><span class="line">        glm::<span class="built_in">lookAt</span>(glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>), glm::<span class="built_in">vec3</span>(<span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>),</span><br><span class="line">                    glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">-1.0f</span>, <span class="number">0.0f</span>)),</span><br><span class="line">        glm::<span class="built_in">lookAt</span>(glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>), glm::<span class="built_in">vec3</span>(<span class="number">-1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>),</span><br><span class="line">                    glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">-1.0f</span>, <span class="number">0.0f</span>)),</span><br><span class="line">        glm::<span class="built_in">lookAt</span>(glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>), glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>),</span><br><span class="line">                    glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>)),</span><br><span class="line">        glm::<span class="built_in">lookAt</span>(glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>), glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">-1.0f</span>, <span class="number">0.0f</span>),</span><br><span class="line">                    glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">-1.0f</span>)),</span><br><span class="line">        glm::<span class="built_in">lookAt</span>(glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>), glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>),</span><br><span class="line">                    glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">-1.0f</span>, <span class="number">0.0f</span>)),</span><br><span class="line">        glm::<span class="built_in">lookAt</span>(glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>), glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">-1.0f</span>),</span><br><span class="line">                    glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">-1.0f</span>, <span class="number">0.0f</span>))&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i&lt;<span class="number">6</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout&lt;&lt;glm::<span class="built_in">to_string</span>(captureProjection * captureViews[i])&lt;&lt;std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qgu.io/blog/2020/07/13/vim-vs-keybinding/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Q Gu">
      <meta itemprop="description" content="Ideas are mine and mine only">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QGU">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020/07/13/vim-vs-keybinding/" class="post-title-link" itemprop="url">Visual Assist like keybindings for Vim</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-13 11:59:00" itemprop="dateCreated datePublished" datetime="2020-07-13T11:59:00+00:00">2020-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-25 19:54:14" itemprop="dateModified" datetime="2022-05-25T19:54:14+00:00">2022-05-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/vim/" itemprop="url" rel="index"><span itemprop="name">vim</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="visual-assist-like-keybindings-for-vim">Visual Assist like keybindings for Vim</h1>
<p>After developing in Visual Studio at work for a few years, I have been spoiled by the convenience of a few shortcuts to navigate around the code. When I get back to Vim at home, my muscle memory can't help to press the same key combinations. To help this situation a little bit, I have created to some of the commonly used shortcuts in Vim to map to the same functionality as Visual Assist. It works surprisingly good so far. Here are a set of key bindings I'll set up in this post:</p>
<table>
<thead>
<tr class="header">
<th>Key</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Shift-Alt-g</td>
<td>Open a file</td>
</tr>
<tr class="even">
<td>Shift-Alt-o</td>
<td>Search for a symbol</td>
</tr>
<tr class="odd">
<td>Alt-m</td>
<td>Jump to symbols in current file</td>
</tr>
<tr class="even">
<td>Shift-Alt-f</td>
<td>Search for all references</td>
</tr>
<tr class="odd">
<td>Alt-o</td>
<td>Jump between headers and sources</td>
</tr>
</tbody>
</table>
<h2 id="tldr">TL;DR</h2>
<ol type="1">
<li>Install Ctags and Cscope</li>
<li>Install CtrlP plugin for Vim</li>
<li>Generate tags in the root folder of the project <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctags -R .</span><br></pre></td></tr></table></figure></li>
<li>Generate Cscope database in the root folder of the project <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscope -R</span><br></pre></td></tr></table></figure></li>
<li>Setup keybindings and Cscope auto load in <code>vimrc</code> <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&quot; Visaul Assist style file and symbol search</span></span><br><span class="line"><span class="keyword">noremap</span> <span class="symbol">&lt;a-s-s&gt;</span> :CtrlPTag<span class="symbol">&lt;cr&gt;</span></span><br><span class="line"><span class="keyword">noremap</span> <span class="symbol">&lt;a-s-o&gt;</span> :CtrlP<span class="symbol">&lt;cr&gt;</span></span><br><span class="line"><span class="keyword">noremap</span> <span class="symbol">&lt;a-m&gt;</span> :CtrlPBufTag<span class="symbol">&lt;cr&gt;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">has</span>(<span class="string">&quot;cscope&quot;</span>)</span><br><span class="line">  <span class="keyword">set</span> cscopetag</span><br><span class="line">  <span class="keyword">set</span> csto=<span class="number">0</span></span><br><span class="line">  <span class="keyword">set</span> <span class="keyword">tags</span>=./<span class="keyword">tags</span>,<span class="keyword">tags</span>;/</span><br><span class="line">  <span class="keyword">set</span> cscopeverbose</span><br><span class="line">  <span class="comment">&quot; add any cscope database in current directory</span></span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">filereadable</span>(<span class="string">&quot;cscope.out&quot;</span>)</span><br><span class="line">    <span class="keyword">cs</span> <span class="built_in">add</span> <span class="keyword">cscope</span>.out</span><br><span class="line">    <span class="comment">&quot; else add the database pointed to by environment variable</span></span><br><span class="line">  <span class="keyword">elseif</span> $CSCOPE_DB != <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">cs</span> <span class="built_in">add</span> $CSCOPE_DB</span><br><span class="line">  <span class="keyword">endif</span></span><br><span class="line">  <span class="keyword">nmap</span> <span class="symbol">&lt;a-s-f&gt;</span> :<span class="keyword">cs</span> <span class="keyword">find</span> s <span class="symbol">&lt;C-R&gt;</span>=<span class="built_in">expand</span>(<span class="string">&quot;&lt;cword&gt;&quot;</span>)<span class="symbol">&lt;CR&gt;</span><span class="symbol">&lt;CR&gt;</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure> ## Open Files with CtrlP</li>
</ol>
<ul>
<li>Required plugin/executable: <a target="_blank" rel="noopener" href="https://github.com/ctrlpvim/ctrlp.vim">CtrlP</a></li>
</ul>
<p>CtrlP is a great plugin to search files in folder, to use the keybinding, simply map the key combinations to invoke CtrlP command: <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">noremap</span> <span class="symbol">&lt;a-s-o&gt;</span> :CtrlP<span class="symbol">&lt;cr&gt;</span></span><br></pre></td></tr></table></figure></p>
<figure>
<img src="https://i.imgur.com/lmx0zxQ.gif" alt="img" /><figcaption>img</figcaption>
</figure>
<h2 id="look-for-symbols-with-ctrlps-symbol-search">Look for Symbols with CtrlP's Symbol Search</h2>
<ul>
<li>Required plugin/executable: <a target="_blank" rel="noopener" href="https://github.com/ctrlpvim/ctrlp.vim">CtrlP</a>, <a target="_blank" rel="noopener" href="http://ctags.sourceforge.net/">Ctags</a></li>
</ul>
<p>CtrlP works great with Ctags by invoking <code>CtrlPTag</code>. It works simply with another key mapping: <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">noremap</span> <span class="symbol">&lt;a-s-s&gt;</span> :CtrlPTag<span class="symbol">&lt;cr&gt;</span></span><br></pre></td></tr></table></figure> Note that tag file is needed to make it work properly, to generate tags file, simply run the ctags at the root folder of the : <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctags -R .</span><br></pre></td></tr></table></figure> <img src="https://i.imgur.com/wACdCIW.gif" alt="img" /></p>
<h2 id="jump-to-a-symbol-in-current-file">Jump to a symbol in current file</h2>
<ul>
<li>Required plugin/executable: <a target="_blank" rel="noopener" href="https://github.com/ctrlpvim/ctrlp.vim">CtrlP</a>, <a target="_blank" rel="noopener" href="http://ctags.sourceforge.net/">Ctags</a></li>
</ul>
<p>Similarly to search for symbols, searching for symbols within the file can be done with <code>CtrlPBufTag</code> command, adding the following key mapping to <code>vimrc</code>: <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">noremap</span> <span class="symbol">&lt;a-m&gt;</span> :CtrlPBufTag<span class="symbol">&lt;cr&gt;</span></span><br></pre></td></tr></table></figure> <img src="https://i.imgur.com/m2o0BBD.gif" alt="img" /></p>
<h2 id="find-all-references-with-cscope">Find all References with Cscope</h2>
<ul>
<li>Required plugin/executable: <a target="_blank" rel="noopener" href="http://cscope.sourceforge.net/">Cscope</a></li>
</ul>
<h3 id="generate-cscope-database-file">Generate Cscope database file</h3>
<p>We'll need to generate a database file for Cscope with command <code>cscope –Rb</code> at the root folder of the project. It will generate <code>cscope.out</code> database that will be used later in Vim.</p>
<h3 id="using-cscope-in-vim">Using Cscope in Vim</h3>
<p>Cscope is a built-in feature for Vim. After generating the Cscope database, we can add it to Vim with <code>:cs add cscope.out</code>. Now, the cscope should be good to go. To search for all the references of a symbol, simply type <code>:cs find s [symbol]</code> <img src="https://i.imgur.com/fZeDYAQ.gif" alt="img" /></p>
<h3 id="keybindings">Keybindings</h3>
<p>Typing all the command with Cscope is too much work, a few keybindings has been provided by the <a target="_blank" rel="noopener" href="http://cscope.sourceforge.net/cscope_vim_tutorial.html">Cscope tutorial</a>, with the vim file provided, you can simply search the references with <code>Ctrl+\ s</code> with the symbol under the cursor.</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">nmap</span> &lt;C-\&gt;s :<span class="keyword">cs</span> <span class="keyword">find</span> s <span class="symbol">&lt;C-R&gt;</span>=<span class="built_in">expand</span>(<span class="string">&quot;&lt;cword&gt;&quot;</span>)<span class="symbol">&lt;CR&gt;</span><span class="symbol">&lt;CR&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="further-optimization">Further optimization</h3>
<p>Search result selection is far from optimal, we'll have to type the selection in command to jump to the specific item. It would be ideal to have something similar to <em>Ctrl-P</em>' s output selection</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="中">
    <link itemprop="mainEntityOfPage" href="https://qgu.io/blog/2020/07/04/multilingual-pelican-cn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Q Gu">
      <meta itemprop="description" content="Ideas are mine and mine only">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QGU">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020/07/04/multilingual-pelican-cn/" class="post-title-link" itemprop="url">Pelican 发布多语言文章</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-04 02:00:00" itemprop="dateCreated datePublished" datetime="2020-07-04T02:00:00+00:00">2020-07-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-25 19:54:14" itemprop="dateModified" datetime="2022-05-25T19:54:14+00:00">2022-05-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/pelican/" itemprop="url" rel="index"><span itemprop="name">pelican</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>你应该已经注意到这篇文章有多个语言的翻译。 Pelican 支持发布多语言文章，只需要一些简答的设置就能实现该功能。以下是我为了实现多语言支持进行的设置。</p>
<h3 id="在pelicanconf.py给各个语言设置相应的-url让每篇文章不同的语言有自己的-url">1. 在<code>pelicanconf.py</code>给各个语言设置相应的 URL，让每篇文章不同的语言有自己的 URL。</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DEFAULT_LANG = <span class="string">&#x27;en&#x27;</span></span><br><span class="line">ARTICLE_URL = <span class="string">&#x27;posts/&#123;date:%Y&#125;/&#123;date:%m&#125;/&#123;slug&#125;/&#x27;</span></span><br><span class="line">ARTICLE_SAVE_AS = <span class="string">&#x27;posts/&#123;date:%Y&#125;/&#123;date:%m&#125;/&#123;slug&#125;/index.html&#x27;</span></span><br><span class="line">ARTICLE_LANG_URL = <span class="string">&#x27;posts/&#123;date:%Y&#125;/&#123;date:%m&#125;/&#123;slug&#125;-&#123;lang&#125;/&#x27;</span></span><br><span class="line">ARTICLE_LANG_SAVE_AS = <span class="string">&#x27;posts/&#123;date:%Y&#125;/&#123;date:%m&#125;/&#123;slug&#125;-&#123;lang&#125;/index.html&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="使用-lang-属性制定文章的语言用相同的-slug-标记同一篇文章">2. 使用 <code>lang</code> 属性制定文章的语言。用相同的 slug 标记同一篇文章。</h3>
<figure>
<img src="%7Bstatic%7D/images/post-meta.png" alt="post-meta" /><figcaption>post-meta</figcaption>
</figure>
<h3 id="将语言选项添加到主题模版中">3. 将语言选项添加到主题模版中</h3>
<p>有些模版未提供多语言选项，比如我使用的<code>aboutwilson</code> 模版。这种情况只要将语言选项的 section 加入到模版的相应文件 <code>themes/aboutwilson/templates/article.html</code> 中就行了。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if article.translations %&#125; </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    Languages:</span><br><span class="line">    &#123;% for translation in article.translations %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">itemprop</span>=<span class="string">&quot;translation&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; SITEURL &#125;&#125;/&#123;&#123; translation.url &#125;&#125;&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;translation&quot;</span>&gt;</span>&#123;&#123;translation.lang&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qgu.io/blog/2020/07/04/multilingual-pelican/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Q Gu">
      <meta itemprop="description" content="Ideas are mine and mine only">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QGU">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020/07/04/multilingual-pelican/" class="post-title-link" itemprop="url">Multilingual post with Pelican</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-04 02:00:00" itemprop="dateCreated datePublished" datetime="2020-07-04T02:00:00+00:00">2020-07-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-25 19:54:14" itemprop="dateModified" datetime="2022-05-25T19:54:14+00:00">2022-05-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/pelican/" itemprop="url" rel="index"><span itemprop="name">pelican</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>You may have noticed that this post has multiple translations. Pelican has multilingual support for posts. It's easy to use but requires some configurations. Here are my configurations to make it work for my blog.</p>
<h3 id="set-up-urls-for-different-languages-in-pelicanconf.py-so-that-each-language-will-have-its-own-url.">1. Set up URLs for different languages in <code>pelicanconf.py</code> so that each language will have its own URL.</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DEFAULT_LANG = <span class="string">&#x27;en&#x27;</span></span><br><span class="line">ARTICLE_URL = <span class="string">&#x27;posts/&#123;date:%Y&#125;/&#123;date:%m&#125;/&#123;slug&#125;/&#x27;</span></span><br><span class="line">ARTICLE_SAVE_AS = <span class="string">&#x27;posts/&#123;date:%Y&#125;/&#123;date:%m&#125;/&#123;slug&#125;/index.html&#x27;</span></span><br><span class="line">ARTICLE_LANG_URL = <span class="string">&#x27;posts/&#123;date:%Y&#125;/&#123;date:%m&#125;/&#123;slug&#125;-&#123;lang&#125;/&#x27;</span></span><br><span class="line">ARTICLE_LANG_SAVE_AS = <span class="string">&#x27;posts/&#123;date:%Y&#125;/&#123;date:%m&#125;/&#123;slug&#125;-&#123;lang&#125;/index.html&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="write-articles-in-different-languages-with-lang-property-in-the-meta.-simply-set-the-property-and-write-the-post-in-corresponding-language.">2. Write articles in different languages with <code>lang</code> property in the meta. Simply set the property and write the post in corresponding language.</h3>
<figure>
<img src="%7Bstatic%7D/images/post-meta.png" alt="post-meta" /><figcaption>post-meta</figcaption>
</figure>
<h3 id="add-language-selector-to-theme-template">3. Add language selector to theme template</h3>
<p>If needed, add language selection tags in the article template of the theme. I'm using <code>aboutwilson</code> theme which doesn't contain the translation field. In this case, I added the links to the template of the theme in <code>themes/aboutwilson/templates/article.html</code> right below the <code>tags</code> section.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if article.translations %&#125; </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    Languages:</span><br><span class="line">    &#123;% for translation in article.translations %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">itemprop</span>=<span class="string">&quot;translation&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; SITEURL &#125;&#125;/&#123;&#123; translation.url &#125;&#125;&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;translation&quot;</span>&gt;</span>&#123;&#123;translation.lang&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Q Gu</p>
  <div class="site-description" itemprop="description">Ideas are mine and mine only</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Q Gu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
